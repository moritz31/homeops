apiVersion: grafana.integreatly.org/v1beta1
kind: Grafana
metadata:
  name: grafana
  namespace: monitoring
  labels:
    dashboards: "grafana"
spec:
  deployment:
    spec:
      replicas: 1
      template:
        spec:
          containers:
            - name: grafana
              image: grafana/grafana:10.0.0
              envFrom:
                - secretRef:
                    name: grafana-secrets
                - secretRef:
                    name: grafana-env
              resources:
                limits:
                  memory: 200Mi
                requests:
                  cpu: 50m
                  memory: 100Mi
  ingress:
    metadata:
      annotations: 
        external-dns.alpha.kubernetes.io/hostname: grafana.kirstein.me
        external-dns.alpha.kubernetes.io/target: home.kirstein.me
    spec:
      ingressClassName: external-ingress
      rules:
        - host: grafana.kirstein.me
          http:
            paths:
              - backend:
                  service:
                    name: grafana-service
                    port:
                      number: 3000
                path: /
                pathType: Prefix
  config:
    alerting:
      enabled: false
    unified_alerting:
      enabled: false
    auth: 
      signout_redirect_url: https://auth.kirstein.me/application/o/grafana/end-session/
      oauth_auto_login: true
    auth.generic_oauth:
      name: authentik
      enabled: true
      scopes: openid email profile
      auth_url: https://auth.kirstein.me/application/o/authorize/
      token_url: https://auth.kirstein.me/application/o/token/
      api_url: https://auth.kirstein.me/application/o/userinfo/
      role_attribute_path: contains(groups[*], 'Grafana Admins') && 'Admin' || contains(groups[*], 'Grafana Editors') && 'Editor' || 'Viewer'
    log:
      mode: "console"
      level: "error"
    log.frontend:
      enabled: true
    server:
      domain: grafana.kirstein.me
      root_url: "https://%(domain)s"